ПРОМТ ДЛЯ REPLIT AGENT (ВЫПОЛНИТЬ СТРОГО ПО ШАГАМ)
0) Правила выполнения (обязательные)
Никаких заявлений “готово/работает” без артефактов (curl/скрины/SQL/файлы debug).

Любая ошибка внешнего сервиса (РКН, YooKassa) не должна валить аудит/страницу: возвращаем понятный статус и продолжаем.​

Никаких хардкодов цен (900 и т.п.) — цены только из БД/админки (audit_packages).​

Если цена не найдена/пакет неактивен/цена 0 → возвращать 400 и не создавать платёж.​

Часть 1. Модель 2 услуг (строгое разделение)
1.1 Две услуги (бизнес-логика)
Услуга №1: Экспресс‑проверка

Бесплатная проверка: показывает краткий отчёт сразу на экране.

Платный продукт: express_report = “Полный отчёт по экспресс‑проверке (PDF)”. Цена редактируется в админке.​

Услуга №2: Полный аудит сайта

Платный продукт: пакет полного аудита по типу сайта (landing, ecommerce, medical, children, …). Цена редактируется в админке.​

1.2 Единый источник цены
Таблица audit_packages — единственный источник:

type (уникальный ключ продукта)

name

price (integer, рубли)

is_active
Никаких других мест “где хранится цена”.​

Часть 2. API: пакеты, цена, создание платежа
2.1 Добавить публичный API чтения пакетов (для UI)
Сделать endpoint (публичный, read-only):

GET /api/public/packages → возвращает список активных пакетов: { type, name, price, isActive }

поддержка ?type=express_report и т.п. (фильтр).
UI не должен содержать цены захардкоженными — он их получает только отсюда.​

2.2 /api/payments/create — только auditId + метод оплаты
Переделать (или проверить) контракт:

POST /api/payments/create body: { auditId: number, paymentMethod: "sbp" | "bank_card" | ... }

Никаких amount/finalAmount/price от клиента — игнорировать, если есть.​

2.2.1 Алгоритм расчёта суммы (строго)
Внутри /api/payments/create:

audit = getAuditById(auditId)

packageType = audit.packageType (это главный ключ)

pkg = audit_packages where type=packageType

if !pkg or !pkg.is_active → 400 "Package inactive or not found"

if pkg.price <= 0 → 400 "Package price not configured"

amountValue = pkg.price + ".00" (рубли → строка)

Создать YooKassa payment с amount.value=amountValue, currency="RUB", корректным description.

2.2.2 Правильные названия платежа (description)
Для packageType=="express_report":
description = "Оплата за полный отчет (экспресс-проверка)"

Для полного аудита (landing/ecommerce/...):
description = "Оплата за полный аудит сайта: " + pkg.name
Запрещено писать “покупка пакета” для экспресс‑отчёта.

2.2.3 Запрет нулевой суммы
Если в YooKassa форма показывает 0 ₽ — это блокирующий баг.
Нужно обеспечить, что amount всегда > 0 и берётся только из БД.​

Часть 3. Два разных флоу покупки
3.1 Флоу №1: экспресс → покупка express_report
3.1.1 Экспресс проверка (бесплатно)
POST /api/public/express-check делает проверку и возвращает данные краткого отчёта (scorePercent, severity, checks[], counts).​

UI сразу показывает краткий отчёт (см. Часть 6).

3.1.2 Покупка полного отчёта по экспрессу (платно)
POST /api/express-report/purchase:

принимает { token }

требует авторизацию (requireAuth)​

создаёт audit на основе public_audits и ставит:

audit.packageType = "express_report"

audit.status = "pending_payment"

возвращает { auditId }
Дальше UI вызывает /api/payments/create и редиректит на YooKassa.

3.2 Флоу №2: полный аудит → выбор пакета → оплата
POST /api/audits:

принимает { websiteUrl, packageType } (packageType строго один из audit_packages.type)​

создаёт audit со статусом pending_payment (или аналог)

затем UI вызывает /api/payments/create по auditId.

Часть 4. YooKassa: убрать ошибку Authentication type is not allowed
4.1 Не передавать authentication_type для СБП
При paymentMethod="sbp":

не добавлять payment_method_data.authentication_type вообще

формировать payload, совместимый с выбранным методом.
Цель: больше не получать 400 “Authentication type is not allowed”.

4.2 Debug артефакты (временно, обязательно)
Перед отправкой запроса в YooKassa в /api/payments/create:

записать payload в debug/yookassa-last-payload.json

записать response/error в debug/yookassa-last-response.json
Запрет: не писать shopId/secretKey/Authorization.

Часть 5. РКН по ИНН (парсинг + кэш + UX) в обоих сервисах
5.1 Что проверяем
Проверяем реестр операторов ПДн на pd.rkn.gov.ru через неофициальный парсинг публичной страницы (если доступна).

5.2 Реализация
Использовать cheerio для HTML (разрешено).

Кэш 24 часа в таблице rkn_registry_cache (inn unique, raw_data jsonb, last_checked_at).

Если ошибка/403/капча → rknCheck.status="failed", но аудит продолжается.

5.3 UX “ИНН найден/не найден”
Если ИНН найден автоматически: проверка запускается автоматически.

Если ИНН не найден: модалка ввода ИНН + чекбокс skip, и дисклеймер при skip.
Сделать и для экспресс, и для полного аудита.

Часть 6. Краткий отчёт СРАЗУ после экспресс‑проверки (обязательно)
6.1 Что показывать сразу (без оплаты)
Сразу после проверки на странице результата экспресса показать:

URL

scorePercent + severity (уровень риска)

счетчики passed/warning/failed/total

список 7 критериев: имя, статус, короткая деталь
Это данные из ответа POST /api/public/express-check (не из PDF).​

6.2 Где фиксить
В компоненте результата экспресса (агент уже трогал client/src/components/express-check.tsx) вернуть рендер краткого отчёта и убедиться, что он видим по умолчанию (не скрыт за “купить”).

Часть 7. PDF и кириллица (особенно iPhone)
7.1 Требование
PDF должен открываться на iPhone (Files/Preview) и кириллица читается.

7.2 Реализация в PDFKit
Использовать только TTF/OTF шрифты с кириллицей (например DejaVuSans.ttf или корректный Roboto TTF).

Явно registerFont и использовать этот font для всего текста.

Добавить smoke‑строку в PDF: “Проверка кириллицы: Привет”.

Часть 8. Приёмка (без этого задача не закрыта)
8.1 Пакеты/цены (админка → UI)
В админке поменять цену express_report (например 900 → 901).

На странице экспресса цена “Купить полный отчёт” должна стать 901 автоматически.

В YooKassa сумма должна быть 901₽ (не 0).

8.2 Экспресс краткий отчёт
Сделать экспресс‑проверку → сразу виден краткий отчёт (без оплаты). Скрин обязателен.

8.3 Оплата и PDF
До оплаты: GET /api/audits/:id/pdf → 402/403

После оплаты (webhook): GET /api/audits/:id/pdf → 200
Плюс приложить debug файлы YooKassa.

8.4 iPhone кириллица
Приложить тестовый PDF + скрин с iPhone, что кириллица читается.

8.5 Отчёт об изменениях
В конце выдать:

список изменённых файлов

список миграций/таблиц

какие endpoints добавлены/изменены